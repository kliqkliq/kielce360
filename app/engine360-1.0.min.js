function Engine360(e){function O(c,a,b){m&&$(m).is(":hidden")&&$(m).show();var d,f;for(f=g.children.length-1;0<=f;f--)d=g.children[f],"camera"!=d&&g.remove(d);d=new THREE.SphereGeometry(l,60,40);c=THREE.ImageUtils.loadTexture(c);var e=new THREE.Texture,e=THREE.ImageUtils.loadTexture(a,{},function(){n.material.map=e;n.material.needsUpdate=!0;m&&$(m).is(":visible")&&$(m).hide()});a=new THREE.MeshBasicMaterial({map:c});n=new THREE.Mesh(d,a);n.scale.x=-1;n.name="panoSphere";g.add(n);for(portalIndex in b){a=
b[portalIndex];var h=parseInt(a.x);c=parseInt(a.y);var p=parseInt(a.max_x);f=p/2;var k=!1;"text"==a.type?d=new THREE.TextGeometry(a.text,{size:80,height:10,font:"helvetiker",curveSegments:2}):"arrow_up"==a.type?d=u.arrowUp:"arrow_down"==a.type?d=u.arrowDown:(d=new THREE.SphereGeometry(24,6,6),k=!0);k=new THREE.MeshBasicMaterial({color:parseInt("0x"+a.color),opacity:parseFloat(a.opacity),wireframe:k,transparent:!0,blending:THREE.AdditiveBlending});d=new THREE.Mesh(d,k);h=h>f?h-f:h+f;h=h/p*360-180;
p=(c/f*180-90)/-1;c=(l-80)*Math.cos(p*Math.PI/180)*Math.cos(h*Math.PI/180);f=(l-80)*Math.sin(p*Math.PI/180);h=(l-80)*Math.cos(p*Math.PI/180)*Math.sin(h*Math.PI/180);d.position.set(c,f,h);d.lookAt(F);d.scale.set(a.scale,a.scale,a.scale);d.name="portal,"+a.target_panorama_id;g.add(d);G.push(d)}}function H(){requestAnimationFrame(H);I()}function P(){k+=0.1}function I(){r=Math.max(-85,Math.min(85,r));v=(90-r)*Math.PI/180;z=k*Math.PI/180;b.target.x=l*Math.sin(v)*Math.cos(z);b.target.y=l*Math.cos(v);b.target.z=
l*Math.sin(v)*Math.sin(z);s>Q?w=-1:0>s&&(w=1);s+=R*w;var c,a;for(a=g.children.length-1;0<=a;a--)c=g.children[a],"camera"!=c&&"panoSphere"!=c.name&&(c.position.y+=s*w);b.lookAt(b.target);x&&(b.position.x=-b.target.x,b.position.y=-b.target.y,b.position.z=-b.target.z);t.render(g,b)}var m,g,F,b,t,J,n,A,B,v=0,z=0,Q=0.5,R=0.01,s=0,w=1,l=500,y=1,C=90,K,L,k=0,r=0,M=0,N=0,D=!1,x=!1,E=!1,G=[],u=[];this.loadPanorama=function(c,a,b){O(c,a,b)};this.onPortalEnter=function(c){B=c};this.start=function(){H()};this.stop=
function(){};this.getFov=function(){return C};this.enableDistortion=function(){x=!0};this.disableDistortion=function(){x=!1;b.position.x=0;b.position.y=0;b.position.z=0};this.enableAutorotate=function(){E=!0;A=setInterval(P,10)};this.disableAutorotate=function(){E=!1;clearInterval(A);A=""};this.getInteractionStatus=function(){return D};this.getDistortionStatus=function(){return x};this.getAutorotateStatus=function(){return E};this.changePerpsective=function(c){175>c&&1<c&&(c=C=c,y=Math.max(1,Math.min(l-
5,y)),b.projectionMatrix.makePerspective(c,window.innerWidth/window.innerHeight,y,1100),I(),$("#fovstatus").text(c))};this.setLoadingContainer=function(c){m=c};this.startInteraction=function(c,a){K=c;L=a;M=k;N=r;var q=new THREE.Vector3(c/window.innerWidth*2-1,2*-(a/window.innerHeight)+1,1);J.unprojectVector(q,b);q=(new THREE.Raycaster(b.position,q.sub(b.position).normalize())).intersectObjects(G);0<q.length&&(data=q[0].object.name.split(","),"portal"==data[0]?void 0!=B&&B(data[1]):"info"==data[0]?
$("#info").css({left:onMouseDownX,top:onMouseDownY}).html(info[data[1]]).show():"photo"==data[0]&&$("#photo").css({left:onMouseDownX,top:onMouseDownY}).html('<img class="photo" src="data/'+data[1]+"/"+data[2]+'">').show());D=!0};this.stopInteraction=function(){D=!1};this.setRotation=function(c,a,b){k=(K-c)*b+M;r=(a-L)*b+N};this.onWindowResize=function(){b.aspect=$(e).width()/$(e).height();b.updateProjectionMatrix();t.setSize($(e).width(),$(e).height())};g=new THREE.Scene;F=new THREE.Vector3(0,0,0);
b=new THREE.PerspectiveCamera(C,$(e).width()/$(e).height(),y,1100);b.target=new THREE.Vector3(0,0,0);g.add(b);J=new THREE.Projector;t=new THREE.WebGLRenderer;t.setSize($(e).width(),$(e).height());$(e).append(t.domElement);(function(){var c={amount:5,curveSegments:4,bevelSegments:1,bevelThickness:1,bevelSize:1},a=new THREE.Shape;a.moveTo(40,0);a.lineTo(0,60);a.lineTo(80,60);a.lineTo(40,0);a=new THREE.Shape;a.moveTo(20,0);a.lineTo(0,25);a.lineTo(10,25);a.lineTo(10,50);a.lineTo(30,50);a.lineTo(30,25);
a.lineTo(40,25);a.lineTo(20,0);var b=new THREE.Shape;b.moveTo(20,50);b.lineTo(40,25);b.lineTo(30,25);b.lineTo(30,0);b.lineTo(10,0);b.lineTo(10,25);b.lineTo(0,25);b.lineTo(20,50);u.arrowDown=a.extrude(c);u.arrowUp=b.extrude(c)})()};